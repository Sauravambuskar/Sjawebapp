<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Documents | SJA Foundation</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/img/favicon.svg">
</head>
<body class="bg-light" data-bs-theme="light">
    <div class="spinner-overlay d-none" id="loading-spinner">
        <div class="spinner-container">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">Loading...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-body p-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="fw-bold">KYC Documents</h2>
                                <p class="text-muted">Upload your identity and address verification documents</p>
                            </div>
                            <a href="client-dashboard.html" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
                            </a>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Please upload clear, high-resolution images of your documents. All documents will be verified by our team within 24-48 hours.
                        </div>
                        
                        <div class="alert alert-danger d-none" id="kyc-error"></div>
                        <div class="alert alert-success d-none" id="kyc-success"></div>
                        
                        <div id="kyc-status-container" class="mb-4">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="status-indicator status-pending" id="kyc-status-indicator"></span>
                                </div>
                                <div>
                                    <h5 class="mb-1">KYC Status: <span id="kyc-status-text">Not Submitted</span></h5>
                                    <p class="text-muted mb-0" id="kyc-status-message">Please upload all required documents</p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="kyc-form">
                            <div class="row g-4">
                                <!-- Profile Photo -->
                                <div class="col-md-6">
                                    <label class="form-label">Profile Photo <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="profile-photo-preview">
                                        <input type="file" class="d-none" id="profile-photo-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-camera fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Upload a recent passport-size photo with white background</small>
                                </div>
                                
                                <!-- Aadhaar Card -->
                                <div class="col-md-6">
                                    <label class="form-label">Aadhaar Card <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="aadhaar-preview">
                                        <input type="file" class="d-none" id="aadhaar-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-id-card fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Upload front and back side in a single image</small>
                                </div>
                                
                                <!-- PAN Card -->
                                <div class="col-md-6">
                                    <label class="form-label">PAN Card <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="pan-preview">
                                        <input type="file" class="d-none" id="pan-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-id-card fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Upload a clear image of your PAN card</small>
                                </div>
                                
                                <!-- Passport (Optional) -->
                                <div class="col-md-6">
                                    <label class="form-label">Passport (Optional)</label>
                                    <div class="doc-preview" id="passport-preview">
                                        <input type="file" class="d-none" id="passport-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-passport fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Upload first and last page in a single image</small>
                                </div>
                                
                                <!-- Address Proof -->
                                <div class="col-md-6">
                                    <label class="form-label">Address Proof <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="address-proof-preview">
                                        <input type="file" class="d-none" id="address-proof-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-home fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Utility bill, rental agreement, etc. (not older than 3 months)</small>
                                </div>
                                
                                <!-- Bank Passbook/Statement -->
                                <div class="col-md-6">
                                    <label class="form-label">Bank Passbook/Statement <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="passbook-preview">
                                        <input type="file" class="d-none" id="passbook-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-university fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">First page of passbook or bank statement showing your name and account details</small>
                                </div>
                                
                                <!-- Signature -->
                                <div class="col-md-6">
                                    <label class="form-label">Signature <span class="text-danger">*</span></label>
                                    <div class="doc-preview" id="signature-preview">
                                        <input type="file" class="d-none" id="signature-input" accept="image/*">
                                        <div class="upload-icon">
                                            <i class="fas fa-signature fa-2x"></i>
                                            <p class="mt-2">Click to upload</p>
                                        </div>
                                    </div>
                                    <small class="text-muted">Upload a clear image of your signature on white paper</small>
                                </div>
                                
                                <div class="col-12 mt-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="terms-checkbox">
                                        <label class="form-check-label" for="terms-checkbox">
                                            I confirm that all the information and documents provided are true and authentic. I understand that any false information may result in rejection of my application.
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-12 mt-4">
                                    <button type="button" class="btn btn-primary btn-lg" id="submit-kyc-btn" disabled>
                                        Submit KYC Documents
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.31.0/dist/umd/supabase.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize variables
            let currentUser = null;
            let userKyc = null;
            const docPreviews = document.querySelectorAll('.doc-preview');
            const submitBtn = document.getElementById('submit-kyc-btn');
            const termsCheckbox = document.getElementById('terms-checkbox');
            const kycError = document.getElementById('kyc-error');
            const kycSuccess = document.getElementById('kyc-success');
            
            // Show loading spinner
            const showLoading = () => {
                document.getElementById('loading-spinner').classList.remove('d-none');
            };
            
            // Hide loading spinner
            const hideLoading = () => {
                document.getElementById('loading-spinner').classList.add('d-none');
            };
            
            // Check authentication
            const checkAuth = async () => {
                showLoading();
                
                try {
                    const { data, error } = await window.supabaseClient.auth.getSession();
                    
                    if (error || !data.session) {
                        // Redirect to login page if not authenticated
                        window.location.href = '../index.html';
                        return;
                    }
                    
                    // Get user data
                    const { data: userData, error: userError } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', data.session.user.id)
                        .single();
                    
                    if (userError) throw userError;
                    
                    // Store user data
                    currentUser = userData;
                    
                    // Get KYC data
                    const { data: kycData, error: kycError } = await window.supabaseClient
                        .from('kyc_docs')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (!kycError) {
                        userKyc = kycData;
                        updateKycStatus();
                        loadDocumentPreviews();
                    }
                    
                } catch (error) {
                    console.error('Authentication error:', error);
                    alert('Authentication failed. Please login again.');
                    window.location.href = '../index.html';
                } finally {
                    hideLoading();
                }
            };
            
            // Update KYC status
            const updateKycStatus = () => {
                const statusIndicator = document.getElementById('kyc-status-indicator');
                const statusText = document.getElementById('kyc-status-text');
                const statusMessage = document.getElementById('kyc-status-message');
                
                if (!userKyc) {
                    statusIndicator.className = 'status-indicator status-inactive';
                    statusText.textContent = 'Not Submitted';
                    statusMessage.textContent = 'Please upload all required documents';
                    return;
                }
                
                switch (userKyc.status) {
                    case 'approved':
                        statusIndicator.className = 'status-indicator status-active';
                        statusText.textContent = 'Approved';
                        statusMessage.textContent = 'Your KYC has been verified and approved';
                        disableForm();
                        break;
                    case 'rejected':
                        statusIndicator.className = 'status-indicator status-inactive';
                        statusText.textContent = 'Rejected';
                        statusMessage.textContent = 'Your KYC was rejected. Please upload correct documents.';
                        break;
                    default:
                        statusIndicator.className = 'status-indicator status-pending';
                        statusText.textContent = 'Pending';
                        statusMessage.textContent = 'Your KYC is under review. This may take 24-48 hours.';
                        disableForm();
                }
            };
            
            // Disable form after submission
            const disableForm = () => {
                docPreviews.forEach(preview => {
                    preview.style.pointerEvents = 'none';
                    preview.style.opacity = '0.7';
                });
                submitBtn.disabled = true;
                termsCheckbox.disabled = true;
            };
            
            // Load document previews
            const loadDocumentPreviews = async () => {
                if (!userKyc) return;
                
                const docTypes = ['profile_photo', 'aadhaar', 'pan', 'passport', 'address_proof', 'passbook', 'signature'];
                
                for (const docType of docTypes) {
                    if (userKyc[docType]) {
                        const previewElement = document.getElementById(`${docType.replace('_', '-')}-preview`);
                        const uploadIcon = previewElement.querySelector('.upload-icon');
                        
                        // Create image element
                        const img = document.createElement('img');
                        img.src = userKyc[docType];
                        img.alt = docType;
                        
                        // Replace upload icon with image
                        if (uploadIcon) {
                            previewElement.removeChild(uploadIcon);
                            previewElement.appendChild(img);
                        }
                    }
                }
            };
            
            // Handle document preview click
            docPreviews.forEach(preview => {
                preview.addEventListener('click', function() {
                    const inputId = this.id.replace('-preview', '-input');
                    document.getElementById(inputId).click();
                });
            });
            
            // Handle document upload
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    const file = this.files[0];
                    if (!file) return;
                    
                    const previewId = this.id.replace('-input', '-preview');
                    const previewElement = document.getElementById(previewId);
                    const uploadIcon = previewElement.querySelector('.upload-icon');
                    
                    // Check file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please upload an image file');
                        return;
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size should be less than 5MB');
                        return;
                    }
                    
                    // Create image preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Remove existing content
                        while (previewElement.firstChild) {
                            previewElement.removeChild(previewElement.firstChild);
                        }
                        
                        // Create image element
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        previewElement.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            // Handle terms checkbox
            termsCheckbox.addEventListener('change', function() {
                submitBtn.disabled = !this.checked;
            });
            
            // Handle form submission
            submitBtn.addEventListener('click', async function() {
                kycError.classList.add('d-none');
                kycSuccess.classList.add('d-none');
                
                // Check required fields
                const requiredInputs = [
                    'profile-photo-input',
                    'aadhaar-input',
                    'pan-input',
                    'address-proof-input',
                    'passbook-input',
                    'signature-input'
                ];
                
                let missingFields = false;
                requiredInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (!input.files || input.files.length === 0) {
                        if (!userKyc || !userKyc[inputId.replace('-input', '').replace('-', '_')]) {
                            missingFields = true;
                        }
                    }
                });
                
                if (missingFields) {
                    kycError.textContent = 'Please upload all required documents';
                    kycError.classList.remove('d-none');
                    return;
                }
                
                // Show loading state
                showLoading();
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
                
                try {
                    // Upload documents to Supabase Storage
                    const uploadedDocs = {};
                    
                    for (const inputId of ['profile-photo-input', 'aadhaar-input', 'pan-input', 'passport-input', 'address-proof-input', 'passbook-input', 'signature-input']) {
                        const input = document.getElementById(inputId);
                        if (input.files && input.files.length > 0) {
                            const file = input.files[0];
                            const docType = inputId.replace('-input', '').replace(/-/g, '_');
                            const filePath = `${currentUser.id}/${docType}_${Date.now()}.${file.name.split('.').pop()}`;
                            
                            // Upload file
                            const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                                .from('kyc_documents')
                                .upload(filePath, file);
                            
                            if (uploadError) throw uploadError;
                            
                            // Get public URL
                            const { data: publicUrlData } = window.supabaseClient.storage
                                .from('kyc_documents')
                                .getPublicUrl(filePath);
                            
                            uploadedDocs[docType] = publicUrlData.publicUrl;
                        }
                    }
                    
                    // Create or update KYC record
                    if (userKyc) {
                        // Update existing record
                        const { error: updateError } = await window.supabaseClient
                            .from('kyc_docs')
                            .update({
                                ...uploadedDocs,
                                status: 'pending',
                                submitted_at: new Date().toISOString()
                            })
                            .eq('id', userKyc.id);
                        
                        if (updateError) throw updateError;
                    } else {
                        // Create new record
                        const { error: insertError } = await window.supabaseClient
                            .from('kyc_docs')
                            .insert([
                                {
                                    user_id: currentUser.id,
                                    ...uploadedDocs,
                                    status: 'pending',
                                    submitted_at: new Date().toISOString()
                                }
                            ]);
                        
                        if (insertError) throw insertError;
                    }
                    
                    // Show success message
                    kycSuccess.textContent = 'KYC documents submitted successfully! Our team will review them within 24-48 hours.';
                    kycSuccess.classList.remove('d-none');
                    
                    // Reload page after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('KYC submission error:', error);
                    kycError.textContent = error.message || 'Failed to submit KYC documents. Please try again.';
                    kycError.classList.remove('d-none');
                    
                    // Reset button state
                    submitBtn.disabled = !termsCheckbox.checked;
                    submitBtn.textContent = 'Submit KYC Documents';
                } finally {
                    hideLoading();
                }
            });
            
            // Initialize
            checkAuth();
        });
    </script>
</body>
</html> 